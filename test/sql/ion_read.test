# name: test/sql/ion_read.test
# description: read_ion table function
# group: [sql]

require ion

query IIIIII
SELECT bigint,
       varchar,
       bool,
       decimal,
       strftime(timestamptz::TIMESTAMP, '%Y-%m-%dT%H:%M:%S.%fZ') AS ts,
       hex(blob) AS blob
FROM read_ion('test/ion/sample.ion');
----
1	two	true	12.340000000000000000	2020-01-02T03:04:05.678000Z	010203
2	three	NULL	NULL	NULL	NULL
NULL	NULL	false	NULL	NULL	NULL

query I
SELECT typeof(decimal) FROM read_ion('test/ion/sample.ion') LIMIT 1;
----
DOUBLE

query III
SELECT bigint, varchar, bool
FROM read_ion('test/ion/sample.ion', columns := {bigint: 'BIGINT', varchar: 'VARCHAR', bool: 'BOOLEAN'});
----
1	two	true
2	three	NULL
NULL	NULL	false

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := 'BIGINT');
----
Binder Error: read_ion "columns" parameter requires a struct as input.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := {bigint: NULL});
----
Binder Error: read_ion "columns" parameter type specification cannot be NULL.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := {bigint: 1});
----
Binder Error: read_ion "columns" parameter type specification must be VARCHAR.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', foo := 1);
----
Binder Error: Invalid named parameter "foo" for function read_ion

query I
SELECT ion FROM read_ion('test/ion/scalars.ion', records := 'false');
----
1
2
3

query III
SELECT bigint, varchar, bool
FROM read_ion('test/ion/array.ion', format := 'array');
----
1	two	true
2	three	false

query IIII
SELECT id,
       nested.name,
       list_extract(tags, 1),
       list_extract(nums, 2)
FROM read_ion('test/ion/nested.ion');
----
1	alpha	x	2
two	beta	z	NULL

query I
SELECT typeof(id) FROM read_ion('test/ion/nested.ion') LIMIT 1;
----
VARCHAR

query IIII
SELECT id,
       nested.name,
       list_extract(tags, 1),
       list_extract(nums, 2)
FROM read_ion('test/ion/nested.ion',
              columns := {id: 'VARCHAR',
                          nested: 'STRUCT(name VARCHAR, score BIGINT)',
                          tags: 'VARCHAR[]',
                          nums: 'BIGINT[]'});
----
1	alpha	x	2
two	beta	z	NULL

query II
SELECT typeof(nested.score),
       typeof(list_extract(nums, 1))
FROM read_ion('test/ion/conflicts.ion') LIMIT 1;
----
VARCHAR	VARCHAR

query I
SELECT typeof(list_extract(nums, 1))
FROM read_ion('test/ion/conflicts.ion') LIMIT 1;
----
VARCHAR

query II
SELECT nested.score,
       list_extract(nums, 1)
FROM read_ion('test/ion/conflicts.ion');
----
10	1
high	x
12.500000000000000000	3
7	{'k': 1}

query I
SELECT typeof(obj)
FROM read_ion('test/ion/struct_sparse.ion', field_appearance_threshold := 0.8)
LIMIT 1;
----
MAP(VARCHAR, BIGINT)

query I
SELECT typeof(obj)
FROM read_ion('test/ion/struct_sparse.ion', field_appearance_threshold := 0.8, map_inference_threshold := -1)
LIMIT 1;
----
STRUCT(a BIGINT, b BIGINT)

query I
SELECT typeof(obj)
FROM read_ion('test/ion/struct_map.ion', map_inference_threshold := 2)
LIMIT 1;
----
MAP(VARCHAR, BIGINT)

query I
SELECT typeof(nested)
FROM read_ion('test/ion/nested.ion', maximum_depth := 1)
LIMIT 1;
----
STRUCT("name" VARCHAR, score VARCHAR)

query I
SELECT COUNT(*)
FROM read_ion('test/ion/multi_[12].ion');
----
3

query I
SELECT COUNT(*)
FROM read_ion(['test/ion/multi_1.ion', 'test/ion/multi_2.ion']);
----
3

query II
SELECT typeof(a), typeof(b)
FROM read_ion(['test/ion/multi_union_1.ion', 'test/ion/multi_union_2.ion'], union_by_name := true)
LIMIT 1;
----
BIGINT	BIGINT

query I
SELECT COUNT(*)
FROM read_ion(['test/ion/multi_union_1.ion', 'test/ion/multi_union_2.ion'],
              union_by_name := true,
              maximum_sample_files := 1,
              sample_size := 1);
----
2

query I
SELECT ion FROM read_ion('test/ion/scalars_binary.ion', records := false);
----
1
2
3

query I
SELECT name FROM read_ion('test/ion/structs_binary.ion');
----
alpha
beta

query I
SELECT name FROM read_ion('test/ion/array_binary.ion', format := 'array');
----
alpha
beta

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_text.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_binary.ion')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_binary.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_text.ion')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/array_text.ion', format := 'array')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/array_binary.ion', format := 'array')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/array_binary.ion', format := 'array')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/array_text.ion', format := 'array')
);
----
0

query I
SELECT typeof(ion) FROM read_ion('test/ion/bools_text.ion', records := false) LIMIT 1;
----
BOOLEAN

query I
SELECT typeof(ion) FROM read_ion('test/ion/floats_text.ion', records := false) LIMIT 1;
----
DOUBLE

query I
SELECT hex(ion) FROM read_ion('test/ion/blobs_text.ion', records := false);
----
010203
040506

query I
SELECT typeof(ion) FROM read_ion('test/ion/lists_text.ion', records := false) LIMIT 1;
----
BIGINT[]

query I
SELECT typeof(name) FROM read_ion('test/ion/structs_name_int_text.ion') LIMIT 1;
----
BIGINT

query I
SELECT typeof(name) FROM read_ion('test/ion/structs_name_list_text.ion') LIMIT 1;
----
BIGINT[]

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/bools_text.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/bools_binary.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/bools_binary.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/bools_text.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/floats_text.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/floats_binary.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/floats_binary.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/floats_text.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/blobs_text.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/blobs_binary.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/blobs_binary.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/blobs_text.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/lists_text.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/lists_binary.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/lists_binary.ion', records := false)
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/lists_text.ion', records := false)
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_name_int_text.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_name_int_binary.ion')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_name_int_binary.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_name_int_text.ion')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_name_list_text.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_name_list_binary.ion')
);
----
0

query I
SELECT COUNT(*) FROM (
    SELECT * FROM read_ion('test/ion/structs_name_list_binary.ion')
    EXCEPT ALL
    SELECT * FROM read_ion('test/ion/structs_name_list_text.ion')
);
----
0

statement ok
COPY (SELECT 1 AS a, 'x' AS b) TO '__TEST_DIR__/ion_write.ion' (FORMAT ION);

query II
SELECT a, b FROM read_ion('__TEST_DIR__/ion_write.ion');
----
1	x

statement ok
COPY (SELECT 1 AS a UNION ALL SELECT 2) TO '__TEST_DIR__/ion_write_array.ion' (FORMAT ION, ARRAY TRUE);

query I
SELECT a FROM read_ion('__TEST_DIR__/ion_write_array.ion', format := 'array');
----
1
2

statement ok
COPY (SELECT {'name': 'alpha', 'nums': [1, 2]} AS s
      UNION ALL
      SELECT {'name': 'beta', 'nums': [3]} AS s)
TO '__TEST_DIR__/ion_write_nested.ion' (FORMAT ION);

query II
SELECT s.name, list_extract(s.nums, 2)
FROM read_ion('__TEST_DIR__/ion_write_nested.ion');
----
alpha	2
beta	NULL
