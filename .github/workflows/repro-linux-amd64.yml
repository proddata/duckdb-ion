name: Repro linux_amd64 test_release
on:
  workflow_dispatch:

jobs:
  repro:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare cache dir
        run: |
          mkdir -p ccache_dir

      - name: Pull docker image
        run: |
          docker pull duckdb/linux_amd64

      - name: Run test_release in docker
        run: |
          docker run --rm \
            -e LINUX_CI_IN_DOCKER=1 \
            -e VCPKG_BINARY_SOURCES="clear;http,https://vcpkg-cache.duckdb.org,read" \
            -e VCPKG_TOOLCHAIN_PATH=/duckdb_build_dir/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -e VCPKG_TARGET_TRIPLET=x64-linux-release \
            -e VCPKG_HOST_TRIPLET=x64-linux-release \
            -e GEN=ninja \
            -e BUILD_SHELL=1 \
            -e DUCKDB_PLATFORM=linux_amd64 \
            -e AWS_ACCESS_KEY_ID= \
            -e AWS_SECRET_ACCESS_KEY= \
            -e AWS_ENDPOINT_URL= \
            -e AWS_DEFAULT_REGION= \
            -e AWS_REQUEST_CHECKSUM_CALCULATION=when_required \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 bash -lc "make && make test_release"
