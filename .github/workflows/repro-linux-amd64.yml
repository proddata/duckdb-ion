name: Repro linux_amd64 test_release
on:
  workflow_dispatch:

jobs:
  repro:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clean workspace
        run: |
          git clean -fdx

      - name: Show test files
        run: |
          git status --short
          ls -1 test/sql/ion_copy*.test || true
          ls -1 test/sql/ion_read_binary*.test || true

      - name: Prepare cache dir
        run: |
          mkdir -p ccache_dir

      - name: Restart docker to run on /mnt
        run: |
          sudo systemctl stop docker

      - name: Configure Docker with custom data directory
        run: |
          sudo mkdir -p /mnt/docker-data
          echo '{ "data-root": "/mnt/docker-data" }' | sudo tee /etc/docker/daemon.json

      - name: Start Docker with updated storage path
        run: sudo systemctl start docker

      - name: Verify Docker storage path
        run: docker info | grep "Docker Root Dir"

      - name: Show submodule refs
        run: |
          git submodule status
          echo "duckdb: $(cd duckdb && git rev-parse HEAD)"
          echo "extension-ci-tools: $(cd extension-ci-tools && git rev-parse HEAD)"

      - name: Build docker image
        run: |
          docker build \
            --build-arg 'vcpkg_url=https://github.com/microsoft/vcpkg.git' \
            --build-arg 'vcpkg_commit=ce613c41372b23b1f51333815feb3edd87ef8a8b' \
            -t duckdb/linux_amd64 \
            ./extension-ci-tools/docker/linux_amd64

      - name: Create env file for docker
        run: |
          cat <<-EOF > docker_env.txt
          VCPKG_BINARY_SOURCES=clear;http,https://vcpkg-cache.duckdb.org,read
          USE_MERGED_VCPKG_MANIFEST=
          AWS_ACCESS_KEY_ID=
          AWS_SECRET_ACCESS_KEY=
          AWS_ENDPOINT_URL=
          AWS_DEFAULT_REGION=
          AWS_REQUEST_CHECKSUM_CALCULATION=when_required
          VCPKG_TARGET_TRIPLET=x64-linux-release
          VCPKG_HOST_TRIPLET=x64-linux-release
          VCPKG_OVERLAY_TRIPLETS=/duckdb_build_dir/extension-ci-tools/toolchains
          VCPKG_OVERLAY_PORTS=/duckdb_build_dir/extension-ci-tools/vcpkg_ports
          BUILD_SHELL=1
          OPENSSL_ROOT_DIR=/duckdb_build_dir/build/release/vcpkg_installed/x64-linux-release
          OPENSSL_DIR=/duckdb_build_dir/build/release/vcpkg_installed/x64-linux-release
          OPENSSL_USE_STATIC_LIBS=true
          DUCKDB_PLATFORM=linux_amd64
          DUCKDB_GIT_VERSION=v1.4.3
          EXTENSION_NAME=ion
          EXTENSION_CANONICAL=
          LINUX_CI_IN_DOCKER=1
          CCACHE_MAXSIZE=1G
          CCACHE_NOCOMPRESS=1
          SUBSET_EXTENSIONS_TESTS=regular
          EOF

      - name: Configure outside docker
        env:
          DUCKDB_GIT_VERSION: v1.4.3
          LINUX_CI_IN_DOCKER: 0
        run: |
          make configure_ci

      - name: Configure in docker
        run: |
          docker run --env-file=docker_env.txt \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 make configure_ci

      - name: Build in docker
        run: |
          docker run --env-file=docker_env.txt \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 make release

      - name: Test release in docker
        run: |
          docker run --env-file=docker_env.txt \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 bash -lc "ulimit -c unlimited && (echo core > /proc/sys/kernel/core_pattern 2>/dev/null || true) && make test_release"

      - name: List binary read tests
        if: failure()
        run: |
          ls -1 test/sql/ion_read_binary*.test || true

      - name: Capture core dump backtrace
        if: failure()
        run: |
          docker run --env-file=docker_env.txt \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 bash -lc "yum install -y gdb && core=\$(find /duckdb_build_dir -maxdepth 3 -name 'core*' -type f | head -n 1) && if [[ -n \"\$core\" ]]; then gdb --batch -ex 'set pagination off' -ex 'bt' -c \"\$core\" ./build/release/test/unittest; else echo 'No core file found'; fi"

      - name: Debug binary copy + read tests (gdb)
        if: failure()
        run: |
          docker run --env-file=docker_env.txt \
            -v "$GITHUB_WORKSPACE":/duckdb_build_dir \
            -v "$GITHUB_WORKSPACE/ccache_dir":/ccache_dir \
            duckdb/linux_amd64 bash -lc "yum install -y gdb && MAX_ATTEMPTS=20 GDB_ATTEMPTS=10 bash scripts/run_unittest_debug.sh test/sql/ion_copy_binary.test test/sql/ion_read_binary*.test"
